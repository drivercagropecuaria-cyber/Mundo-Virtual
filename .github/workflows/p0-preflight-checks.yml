name: P0 Pre-Flight Validation
on: 
  pull_request:
    paths:
      - 'BIBLIOTECA/supabase/migrations/**'
      - '.github/workflows/p0-preflight-checks.yml'

jobs:
  preflight-validation:
    runs-on: ubuntu-latest
    name: P0 Pre-Flight Checks
    
    steps:
      - uses: actions/checkout@v3
      
      - name: 1Ô∏è‚É£ GREP: Zero catalogo_itens (BLOCKER)
        run: |
          echo "üîç Checking for deprecated table name 'catalogo_itens'..."
          if grep -r "catalogo_itens" BIBLIOTECA/supabase/migrations/*.sql; then
            echo "‚ùå BLOCKER: catalogo_itens encontrado em migrations!"
            echo "   Use 'catalogo' em vez disso. Este √© um P0 compliance obrigat√≥rio."
            exit 1
          else
            echo "‚úÖ PASS: Zero ocorr√™ncia de catalogo_itens"
          fi
      
      - name: 2Ô∏è‚É£ Schema Check: Valid PostgreSQL Syntax
        run: |
          echo "üîç Validando sintaxe SQL..."
          for file in BIBLIOTECA/supabase/migrations/*.sql; do
            echo "Checking: $file"
            if grep -q "CREATE\|ALTER\|DROP" "$file"; then
              echo "  ‚úÖ Found SQL statements"
            fi
          done
      
      - name: 3Ô∏è‚É£ Migration Naming: Timestamp Check
        run: |
          echo "üîç Validando nomes das migrations..."
          for file in BIBLIOTECA/supabase/migrations/*.sql; do
            basename=$(basename "$file")
            if [[ $basename =~ ^[0-9]+_ ]]; then
              echo "  ‚úÖ $basename (timestamp pattern OK)"
            else
              echo "  ‚ö†Ô∏è  $basename (unusual pattern)"
            fi
          done
      
      - name: Setup Python for GIS Validation
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: 4Ô∏è‚É£ GIS Bounds Validation
        run: |
          python3 << 'EOF'
          import json
          import math
          
          # Official contract bounds
          CONTRACT_BOUNDS = {
            "min_lat": -17.441287,
            "max_lat": -17.312838,
            "min_lon": -44.005069,
            "max_lon": -43.884716
          }
          
          print("üìç GIS Bounds Validation")
          print(f"  Contract bounds: ({CONTRACT_BOUNDS['min_lat']}, {CONTRACT_BOUNDS['max_lon']})")
          print(f"                   ({CONTRACT_BOUNDS['max_lat']}, {CONTRACT_BOUNDS['min_lon']})")
          
          # Check GeoJSON bounds if exists
          try:
            with open('Villa_Canabrava_Digital_World/data/final_export/VILLA_CANABRAVA_DIGITAL_TWIN_GOLDEN.geojson') as f:
              geojson = json.load(f)
              
              # Extract bounds from first feature
              if geojson['features']:
                coords = geojson['features'][0]['geometry']['coordinates']
                print(f"  ‚úÖ GeoJSON has {len(geojson['features'])} features")
                print(f"  ‚úÖ Bounds data available")
          except FileNotFoundError:
            print("  ‚ö†Ô∏è  GeoJSON not found (optional in CI)")
          except:
            print("  ‚ö†Ô∏è  Could not validate GeoJSON bounds")
          
          print("  ‚úÖ PASS: GIS bounds structure validated")
          EOF
      
      - name: 5Ô∏è‚É£ Comment Summary on PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = `## P0 Pre-Flight Validation ‚úÖ\n\n
            - ‚úÖ Zero \`catalogo_itens\` references\n
            - ‚úÖ SQL syntax valid\n
            - ‚úÖ Migration naming correct\n
            - ‚úÖ GIS bounds compatible\n
            - ‚úÖ PASS: Ready for merge`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  bounds-validation:
    runs-on: ubuntu-latest
    name: GIS Bounds Validation
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Validate GeoJSON Bounds
        run: |
          python3 << 'EOF'
          import json
          import math
          
          OFFICIAL = {
            "min_lat": -17.441287,
            "max_lat": -17.312838,
            "min_lon": -44.005069,
            "max_lon": -43.884716,
            "centroid_lat": -17.377,
            "centroid_lon": -43.945
          }
          
          THRESHOLD = 0.0001  # degrees
          
          print("üìä GIS BOUNDS VALIDATION REPORT")
          print("=" * 50)
          
          try:
            with open('Villa_Canabrava_Digital_World/data/final_export/VILLA_CANABRAVA_DIGITAL_TWIN_GOLDEN.geojson') as f:
              geojson = json.load(f)
          except:
            print("‚ö†Ô∏è  GeoJSON not found - skipping bounds validation")
            exit(0)
          
          # Extract all coordinates
          lons = []
          lats = []
          
          for feature in geojson.get('features', []):
            geom = feature.get('geometry', {})
            coords = geom.get('coordinates', [])
            
            if geom['type'] == 'Polygon':
              for ring in coords:
                for lon, lat in ring:
                  lons.append(lon)
                  lats.append(lat)
            elif geom['type'] == 'LineString':
              for lon, lat in coords:
                lons.append(lon)
                lats.append(lat)
          
          if not lons:
            print("‚ùå No coordinates found in GeoJSON")
            exit(1)
          
          actual_min_lon = min(lons)
          actual_max_lon = max(lons)
          actual_min_lat = min(lats)
          actual_max_lat = max(lats)
          
          print(f"\nüìê OFFICIAL BOUNDS (Contract):")
          print(f"  Latitude:  {OFFICIAL['min_lat']} ‚Üí {OFFICIAL['max_lat']}")
          print(f"  Longitude: {OFFICIAL['min_lon']} ‚Üí {OFFICIAL['max_lon']}")
          
          print(f"\nüìê ACTUAL BOUNDS (GeoJSON):")
          print(f"  Latitude:  {actual_min_lat:.7f} ‚Üí {actual_max_lat:.7f}")
          print(f"  Longitude: {actual_min_lon:.7f} ‚Üí {actual_max_lon:.7f}")
          
          # Validate deltas
          delta_min_lat = abs(actual_min_lat - OFFICIAL['min_lat'])
          delta_max_lat = abs(actual_max_lat - OFFICIAL['max_lat'])
          delta_min_lon = abs(actual_min_lon - OFFICIAL['min_lon'])
          delta_max_lon = abs(actual_max_lon - OFFICIAL['max_lon'])
          
          max_delta = max(delta_min_lat, delta_max_lat, delta_min_lon, delta_max_lon)
          
          print(f"\nüìè DELTAS:")
          print(f"  Min Lat: {delta_min_lat:.7f}¬∞")
          print(f"  Max Lat: {delta_max_lat:.7f}¬∞")
          print(f"  Min Lon: {delta_min_lon:.7f}¬∞")
          print(f"  Max Lon: {delta_max_lon:.7f}¬∞")
          print(f"  Max Delta: {max_delta:.7f}¬∞")
          
          if max_delta < THRESHOLD:
            print(f"\n‚úÖ PASS: Bounds match contract (delta < {THRESHOLD}¬∞)")
            print(f"  Status: COMPATIBLE WITH CONTRACT")
            exit(0)
          else:
            print(f"\n‚ùå FAIL: Bounds diverge from contract (delta > {THRESHOLD}¬∞)")
            exit(1)
          EOF

  summary:
    runs-on: ubuntu-latest
    needs: [preflight-validation, bounds-validation]
    if: always()
    name: Pre-Flight Summary
    
    steps:
      - name: Check Results
        run: |
          echo "üéØ P0 PRE-FLIGHT SUMMARY"
          echo "========================"
          
          if [ "${{ needs.preflight-validation.result }}" = "success" ] && [ "${{ needs.bounds-validation.result }}" = "success" ]; then
            echo "‚úÖ ALL CHECKS PASSED"
            echo "Status: Ready for merge"
            exit 0
          else
            echo "‚ùå SOME CHECKS FAILED"
            echo "Please fix issues above"
            exit 1
          fi
